# Nginx server configuration for serving a React single-page application

server {
    # Listen on port 5173 (matching the port exposed in docker-compose.yml)
    listen 5173;
    
    # Accept requests to any server name
    server_name _;
    
    # API proxy configuration - forward all backend-related requests to the backend server
    # This is a more general solution that will handle all backend endpoints (/auth/, /account/, etc.)
    location ~ ^/(auth|account|task|thirdParty|user|phase|project|activity|vuln|threat|mitigation|artifact|ticket|permission|cwe|webhook|workflow|scanner|history|artifact-workflow)/ {
        # Forward requests to the backend server with the complete URI
        proxy_pass http://host.docker.internal:6800;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin http://localhost:5173;
        proxy_set_header Referer http://localhost:5173;
        
        # Enable cookies for authentication
        proxy_cookie_domain host.docker.internal localhost;
        proxy_cookie_path / /;
        
        # Enable WebSockets if needed
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Log the proxy request for debugging
        access_log /var/log/nginx/backend_access.log;
        error_log /var/log/nginx/backend_error.log debug;
    }
    
    # Legacy API endpoint for compatibility
    location /api/ {
        # Forward requests to the backend server
        proxy_pass http://host.docker.internal:6800/;
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin http://localhost:5173;
        proxy_set_header Referer http://localhost:5173;
        
        # Enable cookies for authentication
        proxy_cookie_domain host.docker.internal localhost;
        proxy_cookie_path / /;
        
        # Log the proxy request for debugging
        access_log /var/log/nginx/api_access.log;
        error_log /var/log/nginx/api_error.log debug;
    }
    
    # Main location block for handling all other requests
    location / {
        # Root directory where the static files are stored (from the Dockerfile COPY command)
        root /usr/share/nginx/html;
        
        # Default file to serve
        index index.html;
        
        # The key configuration for single-page applications with client-side routing
        # If the requested URI doesn't match a file/directory, serve index.html instead
        # This allows React Router to handle the routing client-side
        try_files $uri $uri/ /index.html;
        
        # Add additional headers to prevent caching issues with dynamic routes
        add_header Cache-Control "no-cache, must-revalidate";
    }
    
    # Special location block for static assets with caching configuration
    location /assets/ {
        # Same root directory for static assets
        root /usr/share/nginx/html;
        
        # For missing files, try the index
        try_files $uri $uri/ /index.html;
        
        # Enable browser caching for static assets (1 day for now during development)
        expires 1d;
        
        # Add cache control header to prevent transformation of the cached content
        add_header Cache-Control "public, no-transform";
    }
    
    # Handle other static files
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        # Same root directory for static assets
        root /usr/share/nginx/html;
        
        # Enable browser caching for static assets (30 days)
        expires 30d;
        
        # Add cache control header to prevent transformation of the cached content
        add_header Cache-Control "public, no-transform";
    }
    
    # Error handling: redirect all error pages to index.html to let the SPA handle them
    # This is useful for client-side error handling in React
    error_page 404 /index.html;
    error_page 500 502 503 504 /index.html;
}
